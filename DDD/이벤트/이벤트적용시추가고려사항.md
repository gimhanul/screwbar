## 10.6. 이벤트 적용 시 추가 고려 사항

1. 이벤트 소스를 EventEntry 에 추가할지 여부
   - EventEntry 는 이벤트 발생 주체에 대한 정보를 갖지 않음.
   - 따라서 특정 주체가 발생시킨 이벤트만 조회하는 기능을 구현할 수 없음.
   - 이 기능을 구현하려면 이벤트에 발생 주체 정보를 추가해야 함.
2. 포워더에서 전송 실패를 얼마나 허용할 것이냐
   - 포워더는 이벤트에서 전송에 실패하면 실패한 이벤트부터 다시 읽어와 전송을 시도함.
   - 그런데 특정 이벤트에서 계속 전송에 실패하면 어떻게 될까? → 나머지 이벤트를 실행할 수 없음.
   - 포워더를 구현할 때는 실패한 이벤트의 재전송 횟수 제한을 두어야 함.
   > 처리에 실패한 이벤트를 생략하지 않고 별도 실패용 DB 나 메시지 큐에 저장하기도 함. (실패 이유 분석, 후처리)
3. 이벤트 손실
   - 이벤트 저장소를 사용하는 방식은 이벤트 발생고 이벤트 저장을 한 트랜잭션으로 처리하기 때문에 트랜잭션에 성공하면 이벤트가 저장소에 보관된다는 것을 보장할 수 있음.
   - 반면에 로컬 핸들러를 이용해서 이벤트를 비동기로 처리할 경우 이벤트 처리에 실패하면 이벤트를 유실하게 됨.
4. 이벤트 순서
   - 이벤트 발생 순서대로 외부 시스템에 전달해야 할 경우, 이벤트 저장소를 사용하는 것이 좋음.
   - 이벤트 저장소는 저장소에 이벤트를 발생 순서대로 저장하고 그 순서대로 이벤트 목록을 제공하기 때문임.
   - 반면에 메시징 시스템은 사용 기술에 따라 이벤트 발생 순서와 메시지 전달 순서가 다를 수도 있음.
5. 이벤트 재처리
   - 동일한 이벤트를 다시 처리해야할 때 이벤트를 어떻게 할지 결정해야 함.
   - 가장 쉬운 방법은 마지막으로 처리한 이벤트의 순번을 기억해 두었다가 이미 처리한 순번의 이벤트가 도착하면 해당 이벤트를 처리하지 않고 무시하는 것임.
   - 이벤트를 멱등으로 처리하는 방법도 있음.
   > **멱등성 `idempotent`**<br>
   > 연산을 여러 번 적용해도 결과가 달라지지 않는 성질. 절댓값 함수인 `abs()` 가 멱등성을 갖는 가장 대표적인 예임.<br>
   > 비슷하게 이벤트 처리도 동일 이벤트를 한 번 적용하나 여러 번 적용하나 시스템이 같은 상태가 되도록 핸들러를 구현할 수 있음.<br>
   > 이벤트 핸들러가 멱등성을 가지면 시스템 장애로 인해 같은 이벤트가 중복해서 발생해도 결과적으로 동일 상태가 됨.

<br>

### 이벤트 처리와 DB 트랜잭션 고려

예를 들어 주문 취소와 환불 기능을 다음과 같이 이벤트를 이용해서 구현했다고 하자.

- 주문 취소 기능은 주문 취소 이벤트를 발생시킴.
- 주문 취소 이벤트 핸들러는 환불 서비스에 환불 처리를 요청함.
- 환불 서비스는 외부 API 를 호출해서 결제를 취소함.

DB 를 업데이트 하는 과정에서 실패하면 결제 취소 API 를 이미 호출해서 결제는 이미 취소됐는데 DB 에는 주문이 취소되지 않은 채로 남게 됨.
이런 상황은 이벤트 처리를 동기로 하든 비동기로 하든 발생함. 따라서 이벤트 처리 방식과 상관없이 이벤트 처리 실패와 트랜잭션 실패를 함께 고려해야 함.
이를 모두 고려하면 복잡해지므로 경우의 수를 줄이면 도움이 됨. 경우의 수를 줄이는 방법은 **트랜잭션이 성공할 때만 이벤트 핸들러를 실행하는 것**임.

스프링은 트랜잭션 상태에 따라 이벤트 핸들러를 실행할 수 있게 하는  `@Transactional` 애너테이션을 지원함. 

```java
@TransactionalEventListener(
        classes = OrderCanceledEvent.class,
        phase = TransactionPhase.AFTER_COMMIT
)
public void handle(OrderCanceledEvent event) {
    refundService.refund(event.getOrderNumber());
}
```

위 코드에서는 `TransactionPhase.AFTER_COMMIT` 을 지정해서 스트랜잭션 커밋에 성공한 뒤에 핸들러 메서드를 실행함.

트랜잭션이 성공할 때만 이벤트 핸들러를 실행하게 되면 트랜잭션 실패에 대한 경우의 수가 줄어 이제 이벤트 처리 실패만 고민하면 됨.
이벤트는 특성에 따라 재처리 방식을 결정하면 됨.