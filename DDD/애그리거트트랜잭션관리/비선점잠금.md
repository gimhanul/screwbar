## 8.3. 비선점 잠금

<br>

### 선점 잠금의 문제점

선점 잠금으로 모든 트랜잭션 충돌 문제가 해결되는 것은 아님.

![](https://3553248446-files.gitbook.io/~/files/v0/b/gitbook-legacy-files/o/assets%2F-M5HOStxvx-Jr0fqZhyW%2F-MCvkgI26jt9I2m6y0y3%2F-MCvlci7sZL6-DHutgrv%2F8.4.png?alt=media&token=00c12d40-5e3f-409b-86ce-98abed0a6da2)

여기서 문제점은 운영자가 배송지 정보를 조회하고 배송 상태로 변경하는 사이에 고객이 배송지를 변경한다는 것임.

<br>

### 비선점 잠금

선점 잠금의 문제점을 해결함.

동시에 접근하는 것을 막는 대신 **변경한 데이터를 실제 DBMS 에 반영하는 시점에 변경 가능 여부를 확인하는 방식**임.

<br>

### 구현

애그리거트에 버전으로 사용할 숫자 타입 프로퍼티를 추가해야 함.

애그리거트를 수정할 때마다 버전으로 사용할 프로퍼티 값이 1씩 증가하는데, 이때 다음과 같은 쿼리를 사용함.

```sql
UPDATE aggtable SET version = version + 1, colx = ?, coly = ?
WHERE aggid = ? AND version = 현재버전
```

이 쿼리는 수정할 애그리거트와 매핑되는 테이블의 버전 값이 현재 애그리거트의 버전과 동일한 경우에만 데이터를 수정함.

그리고 수정에 성공하면 버전 값은 1 증가시킴.

다른 트랜잭션이 먼저 데이터를 수정해서 버전 값이 바뀌면 데이터 수정에 실패하게 됨.

